<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select & Pay — ASRS Travel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='bookticket.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='booking.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body data-theme="light">

    <!-- Header -->
    <header>
        <div class="logo" onclick="history.back()" style="cursor:pointer;"><i
                class="fas fa-plane logo-plane"></i>SRS<span> Travel</span></div>
        <div class="header-actions">
            <a href="/"><button class="btn btn-ghost"><i class="fas fa-arrow-left"></i> Back</button></a>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-step active" id="step-ind-1">
            <div class="step-bubble">1</div>
            <span>{% if type == 'Hotel' %}Choose Room{% else %}Choose Seat{% endif %}</span>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" id="step-ind-2">
            <div class="step-bubble">2</div>
            <span>Review Order</span>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" id="step-ind-3">
            <div class="step-bubble">3</div>
            <span>Payment</span>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step" id="step-ind-4">
            <div class="step-bubble"><i class="fas fa-check"></i></div>
            <span>Confirmed</span>
        </div>
    </div>

    <!-- Booking Ticket Summary Bar -->
    <div class="booking-summary-bar">
        <div class="bsb-left">
            {% if type == 'Flight' %}<i class="fas fa-plane bsb-icon"></i>
            {% elif type == 'Train' %}<i class="fas fa-train bsb-icon"></i>
            {% elif type == 'Bus' %}<i class="fas fa-bus bsb-icon"></i>
            {% else %}<i class="fas fa-hotel bsb-icon"></i>{% endif %}
            <div>
                <div class="bsb-type">{{ type }}</div>
                <div class="bsb-name">{{ name }}</div>
            </div>
        </div>
        <div class="bsb-route">
            {% if type != 'Hotel' %}
            <div class="bsb-city">{{ src }}</div>
            <div class="bsb-arrow">
                <span>{{ dep }} → {{ arr }}</span>
            </div>
            <div class="bsb-city">{{ dst }}</div>
            {% else %}
            <div class="bsb-city">{{ dst }}</div>
            <div class="bsb-arrow"><span>{{ cls }}</span></div>
            {% endif %}
        </div>
        <div class="bsb-right">
            <div class="bsb-label">Base Price</div>
            <div class="bsb-price">₹{{ price }}</div>
        </div>
    </div>

    <!-- ═══ STEP 1: SEAT / ROOM SELECTION ═══ -->
    <div class="book-step" id="step-1">
        <div class="book-container">

            {% if type == 'Flight' %}
            <!-- ─── AIRPLANE SEAT MAP ─── -->
            <h2 class="step-title"><i class="fas fa-plane"></i> Select Your Seat</h2>
            <p class="step-sub">{{ src }} → {{ dst }} &nbsp;|&nbsp; {{ cls }}</p>

            <div class="seat-legend">
                <div class="legend-item">
                    <div class="seat available"></div> Available
                </div>
                <div class="legend-item">
                    <div class="seat occupied"></div> Occupied
                </div>
                <div class="legend-item">
                    <div class="seat selected"></div> Your Pick
                </div>
                <div class="legend-item">
                    <div class="seat window"></div> Window
                </div>
            </div>

            <div class="airplane-wrapper">
                <div class="plane-nose"></div>
                <div class="seat-map" id="seat-map">
                    <!-- Class Header -->
                    <div class="class-label">Business Class</div>
                    {% for row in range(1, 5) %}
                    <div class="seat-row">
                        <span class="row-num">{{ row }}</span>
                        {% for col in ['A','B'] %}
                        <div class="seat {% if loop.first %}window{% else %}aisle{% endif %} {% if (row == 2 and col == 'B') or (row == 3 and col == 'A') %}occupied{% else %}available{% endif %}"
                            data-seat="{{ row }}{{ col }}" data-price="{{ price + 1500 }}">{{ row }}{{ col }}</div>
                        {% endfor %}
                        <div class="seat-gap"></div>
                        {% for col in ['C','D'] %}
                        <div class="seat {% if loop.last %}window{% else %}aisle{% endif %} {% if (row == 1 and col == 'C') %}occupied{% else %}available{% endif %}"
                            data-seat="{{ row }}{{ col }}" data-price="{{ price + 1500 }}">{{ row }}{{ col }}</div>
                        {% endfor %}
                    </div>
                    {% endfor %}

                    <div class="class-label">Economy Class</div>
                    {% for row in range(5, 25) %}
                    <div class="seat-row">
                        <span class="row-num">{{ row }}</span>
                        {% for col in ['A','B','C'] %}
                        <div class="seat {% if col == 'A' %}window{% elif col == 'C' %}aisle{% endif %} {% if [10,11,14,17,19,21] | select('equalto', row) | list %}occupied{% else %}available{% endif %}"
                            data-seat="{{ row }}{{ col }}" data-price="{{ price }}">{{ row }}{{ col }}</div>
                        {% endfor %}
                        <div class="seat-gap"></div>
                        {% for col in ['D','E','F'] %}
                        <div class="seat {% if col == 'F' %}window{% elif col == 'D' %}aisle{% endif %} {% if [9,13,15,18,20,22] | select('equalto', row) | list %}occupied{% else %}available{% endif %}"
                            data-seat="{{ row }}{{ col }}" data-price="{{ price }}">{{ row }}{{ col }}</div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                <div class="plane-tail"></div>
            </div>

            {% elif type == 'Train' %}
            <!-- ─── TRAIN BERTH MAP ─── -->
            <h2 class="step-title"><i class="fas fa-train"></i> Select Your Berth</h2>
            <p class="step-sub">Train: {{ name }} &nbsp;|&nbsp; {{ cls }}</p>

            <div class="seat-legend">
                <div class="legend-item">
                    <div class="seat available"></div> Available
                </div>
                <div class="legend-item">
                    <div class="seat occupied"></div> Booked
                </div>
                <div class="legend-item">
                    <div class="seat selected"></div> Selected
                </div>
            </div>

            <div class="train-wrapper">
                {% for coach in range(1, 4) %}
                <div class="coach-block">
                    <div class="coach-label">Coach {{ ['B1','B2','B3'][coach-1] }}</div>
                    <div class="berth-grid">
                        {% for section in range(1, 10) %}
                        <div class="berth-section">
                            <div class="berth-section-num">{{ section }}</div>
                            {% for berth in ['LB','MB','UB','SL','SU'] %}
                            {% set s_id = coach ~ '-' ~ section ~ '-' ~ berth %}
                            <div class="berth-box {% if (coach==1 and section==3 and berth=='LB') or (coach==2 and section==5 and berth=='UB') or (coach==1 and section==7 and berth=='MB') %}occupied{% else %}available{% endif %}"
                                data-seat="{{ s_id }}"
                                data-price="{{ price + ({'LB':0,'MB':0,'UB':-200,'SL':100,'SU':80}[berth]) }}">
                                <span class="berth-label">{{ berth }}</span>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            {% elif type == 'Bus' %}
            <!-- ─── BUS SEAT MAP ─── -->
            <h2 class="step-title"><i class="fas fa-bus"></i> Select Your Seat</h2>
            <p class="step-sub">Bus: {{ name }} &nbsp;|&nbsp; {{ cls }}</p>

            <div class="seat-legend">
                <div class="legend-item">
                    <div class="seat available"></div> Available
                </div>
                <div class="legend-item">
                    <div class="seat occupied"></div> Booked
                </div>
                <div class="legend-item">
                    <div class="seat selected"></div> Selected
                </div>
                <div class="legend-item">
                    <div class="seat ladies"></div> Ladies
                </div>
            </div>

            <div class="bus-wrapper">
                <div class="bus-body">
                    <div class="driver-area"><i class="fas fa-steering-wheel"></i> Driver</div>
                    <div class="bus-seats" id="seat-map">
                        {% for row in range(1, 12) %}
                        <div class="seat-row bus-row">
                            <div class="seat {% if row in [1,2] %}ladies{% elif row in [4,7,9] %}occupied{% else %}available{% endif %}"
                                data-seat="{{ row }}A" data-price="{{ price }}">{{ row }}A</div>
                            <div class="seat {% if row in [5,8] %}occupied{% else %}available{% endif %}"
                                data-seat="{{ row }}B" data-price="{{ price }}">{{ row }}B</div>
                            <div class="bus-aisle"></div>
                            <div class="seat {% if row in [3,6] %}occupied{% else %}available{% endif %}"
                                data-seat="{{ row }}C" data-price="{{ price }}">{{ row }}C</div>
                            <div class="seat {% if row in [10] %}occupied{% else %}available{% endif %}"
                                data-seat="{{ row }}D" data-price="{{ price }}">{{ row }}D</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            {% else %}
            <!-- ─── HOTEL ROOM CHOOSER ─── -->
            <h2 class="step-title"><i class="fas fa-hotel"></i> Choose Your Room</h2>
            <p class="step-sub">{{ name }} — {{ dst }}</p>

            <div class="rooms-grid">
                {% set room_types = [
                {"name": "Standard Room", "size": "22 m²", "bed": "1 Queen Bed", "img": "1566073771", "price": price,
                "features": ["Free WiFi", "TV", "AC"]},
                {"name": "Deluxe Suite", "size": "38 m²", "bed": "1 King Bed", "img": "1578894168", "price": price+1500,
                "features": ["Free WiFi", "Mini Bar", "AC", "Balcony"]},
                {"name": "Premium Vista Room", "size": "30 m²", "bed": "2 Double Beds", "img": "1525193707", "price":
                price+800, "features": ["Free WiFi", "Pool View", "AC", "Bathtub"]},
                {"name": "Heritage Presidential","size": "65 m²", "bed": "1 Emperor Bed", "img": "1414005700", "price":
                price+4000, "features": ["Butler", "Private Pool", "Spa", "All Inclusive"]}
                ] %}
                {% for room in room_types %}
                <div class="room-card" data-price="{{ room.price }}" data-room="{{ room.name }}"
                    onclick="selectRoom(this)">
                    <img src="https://picsum.photos/seed/room{{ loop.index }}/600/400" alt="{{ room.name }}">
                    <div class="room-body">
                        <div class="room-name">{{ room.name }}</div>
                        <div class="room-meta">
                            <span><i class="fas fa-ruler-combined"></i> {{ room.size }}</span>
                            <span><i class="fas fa-bed"></i> {{ room.bed }}</span>
                        </div>
                        <div class="room-features">
                            {% for f in room.features %}<span class="amenity-tag">{{ f }}</span>{% endfor %}
                        </div>
                        <div class="room-footer">
                            <div class="room-price">₹{{ room.price }}<span>/night</span></div>
                            <button class="btn btn-ghost room-select-btn">Select Room</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Selection Status Bar -->
            <div class="selection-status" id="selection-status">
                <div class="sel-left">
                    <i class="fas fa-ticket-alt sel-icon"></i>
                    <div>
                        <div id="sel-label">No {% if type == 'Hotel' %}room{% else %}seat{% endif %} selected yet</div>
                        <div id="sel-detail" style="font-size:12px;color:var(--muted);margin-top:2px;"></div>
                    </div>
                </div>
                <div class="sel-right">
                    <div class="sel-price" id="sel-price">₹—</div>
                    <button class="btn btn-primary" id="btn-next-1" onclick="goToStep(2)" disabled>
                        Continue <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══ STEP 2: ORDER REVIEW ═══ -->
    <div class="book-step hidden" id="step-2">
        <div class="book-container">
            <h2 class="step-title"><i class="fas fa-receipt"></i> Review Your Order</h2>

            <div class="review-card">
                <div class="review-row">
                    <span class="review-label">Travel Type</span>
                    <span class="review-value">{{ type }}</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Provider</span>
                    <span class="review-value">{{ name }}</span>
                </div>
                {% if type != 'Hotel' %}
                <div class="review-row">
                    <span class="review-label">Route</span>
                    <span class="review-value">{{ src }} → {{ dst }}</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Departure / Arrival</span>
                    <span class="review-value">{{ dep }} — {{ arr }}</span>
                </div>
                <div class="review-row">
                    <span class="review-label">Class</span>
                    <span class="review-value">{{ cls }}</span>
                </div>
                {% else %}
                <div class="review-row">
                    <span class="review-label">Destination</span>
                    <span class="review-value">{{ dst }}</span>
                </div>
                {% endif %}
                <div class="review-row" id="review-seat-row" style="display:none;">
                    <span class="review-label">{% if type == 'Hotel' %}Room{% else %}Seat{% endif %}</span>
                    <span class="review-value" id="review-seat-val">—</span>
                </div>

                <div class="review-divider"></div>

                <!-- Travelers Dynamic Form -->
                <div id="travelers-section" style="margin-top:20px;display:none;">
                    <h3 style="margin-bottom:12px;font-size:14px;color:#ff9f1c;"><i class="fas fa-users"></i> Traveler
                        Details</h3>
                    <div id="travelers-list"></div>
                </div>

                <div class="review-divider"></div>

                <!-- Coupon Section -->
                <div class="coupon-section" style="margin:20px 0;">
                    <h3 style="margin-bottom:12px;font-size:14px;color:#ff9f1c;"><i class="fas fa-tags"></i> Have a
                        promo code?</h3>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="coupon-code" placeholder="e.g. WELCOME10, TRAVEL20, ASRS50"
                            style="flex:1; padding:10px 14px; border-radius:8px; border:1px solid rgba(255,159,28, .5); background:rgba(0,0,0,0.2); color:#fff; font-family:inherit; font-weight:700;">
                        <button class="btn btn-ghost" onclick="applyCoupon()" style="padding:10px 20px;">Apply</button>
                    </div>
                    <div id="coupon-msg" style="font-size:12px; margin-top:8px; min-height:14px;"></div>
                </div>

                <div class="review-divider"></div>

                <div class="review-row discount-row" id="discount-row" style="display:none; color:#06d6a0;">
                    <span class="review-label" style="color:#06d6a0;">Discount Applied</span>
                    <span class="review-value" id="review-discount">-₹0</span>
                </div>
                <div class="review-row total-row">
                    <span class="review-label">Total Amount</span>
                    <span class="review-value total-price" id="review-total">₹{{ price }}</span>
                </div>
            </div>

            <div class="step-actions">
                <button class="btn btn-ghost" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i> Back</button>
                <button class="btn btn-primary" onclick="goToStep(3)">Proceed to Payment <i
                        class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <!-- ═══ STEP 3: PAYMENT ═══ -->
    <div class="book-step hidden" id="step-3">
        <div class="book-container">
            <h2 class="step-title"><i class="fas fa-lock"></i> Secure Payment</h2>

            <!-- Order Total Banner -->
            <div class="payment-total-bar">
                <span>Amount to Pay</span>
                <span class="pay-amount" id="pay-amount-display">₹{{ price }}</span>
            </div>

            <!-- Payment Method Selector -->
            <div class="payment-methods">
                <div class="pay-method active" onclick="selectPayment(this,'upi')" data-method="upi">
                    <div class="pay-icon"><i class="fas fa-mobile-alt"></i></div>
                    <div class="pay-label">UPI / Online</div>
                    <div class="pay-sub">GPay, PhonePe, Paytm</div>
                </div>
                <div class="pay-method" onclick="selectPayment(this,'card')" data-method="card">
                    <div class="pay-icon"><i class="fas fa-credit-card"></i></div>
                    <div class="pay-label">Debit / Credit Card</div>
                    <div class="pay-sub">Visa, Mastercard, RuPay</div>
                </div>
                <div class="pay-method" onclick="selectPayment(this,'cash')" data-method="cash">
                    <div class="pay-icon"><i class="fas fa-money-bill-wave"></i></div>
                    <div class="pay-label">Cash at Counter</div>
                    <div class="pay-sub">Pay at ticket window</div>
                </div>
            </div>

            <!-- UPI Panel -->
            <div class="pay-panel" id="panel-upi">
                <div class="upi-apps">
                    <button class="upi-btn" onclick="selectUPI(this)"><img
                            src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/24/Paytm_Logo_%28standalone%29.svg/120px-Paytm_Logo_%28standalone%29.svg.png"
                            alt="Paytm">Paytm</button>
                    <button class="upi-btn" onclick="selectUPI(this)"><img
                            src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Google_Pay_Logo.svg/120px-Google_Pay_Logo.svg.png"
                            alt="GPay">Google Pay</button>
                    <button class="upi-btn" onclick="selectUPI(this)"><img
                            src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/71/PhonePe_Logo.svg/120px-PhonePe_Logo.svg.png"
                            alt="PhonePe">PhonePe</button>
                </div>
                <div class="pay-field-group" style="margin-top:20px;">
                    <div class="pay-field">
                        <label>Enter UPI ID</label>
                        <input type="text" placeholder="yourname@upi" id="upi-id">
                    </div>
                </div>
            </div>

            <!-- Card Panel -->
            <div class="pay-panel hidden" id="panel-card">
                <div class="card-visual" id="card-visual">
                    <div class="card-chip"><i class="fas fa-sim-card"></i></div>
                    <div class="card-number" id="cv-num">•••• •••• •••• ••••</div>
                    <div class="card-bottom">
                        <div>
                            <div class="cv-label">Card Holder</div>
                            <div id="cv-name">YOUR NAME</div>
                        </div>
                        <div>
                            <div class="cv-label">Expires</div>
                            <div id="cv-exp">MM/YY</div>
                        </div>
                    </div>
                </div>
                <div class="pay-field-group">
                    <div class="pay-field" style="grid-column:span 2">
                        <label>Card Number</label>
                        <input type="tel" maxlength="19" placeholder="1234 5678 9012 3456" id="card-num"
                            oninput="fmtCard(this)">
                    </div>
                    <div class="pay-field" style="grid-column:span 2">
                        <label>Card Holder Name</label>
                        <input type="text" placeholder="Name on card" id="card-name"
                            oninput="document.getElementById('cv-name').textContent=this.value.toUpperCase()||'YOUR NAME'">
                    </div>
                    <div class="pay-field">
                        <label>Expiry (MM/YY)</label>
                        <input type="tel" maxlength="5" placeholder="MM/YY" id="card-exp" oninput="fmtExpiry(this)">
                    </div>
                    <div class="pay-field">
                        <label>CVV</label>
                        <input type="password" maxlength="3" placeholder="•••" id="card-cvv">
                    </div>
                </div>
            </div>

            <!-- Cash Panel -->
            <div class="pay-panel hidden" id="panel-cash">
                <div class="cash-info">
                    <i class="fas fa-info-circle" style="font-size:40px;color:var(--accent);margin-bottom:16px;"></i>
                    <h3>Pay at the Counter</h3>
                    <p>Your booking will be reserved for <strong>30 minutes</strong>. Please visit the nearest ASRS
                        counter and present your booking reference to complete payment.</p>
                    <div class="cash-ref-box">Booking Ref: <strong>KNY-{{ range(100000,999999)|random }}</strong></div>
                </div>
            </div>

            <div class="step-actions" style="margin-top:32px;">
                <button class="btn btn-ghost" onclick="goToStep(2)"><i class="fas fa-arrow-left"></i> Back</button>
                <button class="btn btn-primary pay-btn" onclick="processPayment()">
                    <i class="fas fa-lock"></i> Pay & Confirm Booking
                </button>
            </div>
        </div>
    </div>

    <!-- ═══ STEP 4: CONFIRMATION ═══ -->
    <div class="book-step hidden" id="step-4">
        <div class="book-container">
            <div class="confirmation-box">
                <div class="confirm-anim">
                    <div class="confirm-circle">
                        <i class="fas fa-check confirm-check"></i>
                    </div>
                </div>
                <h2 class="confirm-title">Booking Confirmed!</h2>
                <p class="confirm-sub">Your journey has been successfully booked.</p>

                <div class="confirm-details">
                    <div class="confirm-row"><span>Booking ID</span><strong id="confirm-id"></strong></div>
                    <div class="confirm-row"><span>Traveller(s)</span><strong id="confirm-traveller">{{ session_user
                            }}</strong></div>
                    <div class="confirm-row"><span>{{ type }}</span><strong>{{ name }}</strong></div>
                    {% if type != 'Hotel' %}
                    <div class="confirm-row"><span>Route</span><strong>{{ src }} → {{ dst }}</strong></div>
                    <div class="confirm-row"><span>Timings</span><strong>{{ dep }} — {{ arr }}</strong></div>
                    {% else %}
                    <div class="confirm-row"><span>Destination</span><strong>{{ dst }}</strong></div>
                    {% endif %}
                    <div class="confirm-row"><span>Seat / Room</span><strong id="confirm-seat"></strong></div>
                    <div class="confirm-row"><span>Amount Paid</span><strong id="confirm-amount"></strong></div>
                    <div class="confirm-row"><span>Payment</span><strong id="confirm-payment"></strong></div>
                </div>

                <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:36px;">
                    <button class="btn btn-primary" onclick="window.print()"><i class="fas fa-download"></i> Download
                        Ticket</button>
                    <a href="/profile"><button class="btn btn-primary"
                            style="background:linear-gradient(135deg,#ff9f1c,#ff5500)"><i class="fas fa-user"></i> My
                            Profile</button></a>
                    <a href="/"><button class="btn btn-ghost"><i class="fas fa-home"></i> Back to Home</button></a>
                </div>
            </div>
        </div>
    </div>

    <button id="theme-toggle"><i class="fas fa-moon"></i></button>
    <script src="{{ url_for('static', filename='bookticket.js') }}"></script>
    <script>
        /* ─── State ─────────────────────────── */
        let selectedSeats = [];
        let basePriceSum = 0;
        let discountAmt = 0;
        let selectedPrice = parseInt("{{ price }}") || 0;
        let selectedPayMethod = 'upi';
        const isHotel = '{{ type }}' === 'Hotel';

        /* ─── Seat Selection ─────────────────── */
        document.querySelectorAll('.seat.available, .seat.window, .seat.ladies, .berth-box.available, .berth-box.ladies').forEach(s => {
            s.addEventListener('click', () => {
                const sId = s.dataset.seat;
                if (s.classList.contains('selected')) {
                    s.classList.remove('selected');
                    selectedSeats = selectedSeats.filter(id => id !== sId);

                    const prev = s.classList.contains('window') || s.classList.contains('ladies');
                    if (!prev) s.classList.add('available');
                } else {
                    s.classList.add('selected');
                    s.classList.remove('available');
                    selectedSeats.push(sId);
                }

                basePriceSum = 0;
                document.querySelectorAll('.seat.selected, .berth-box.selected').forEach(x => {
                    basePriceSum += parseInt(x.dataset.price || 0);
                });
                applyCoupon();
                updateSelectionBar();
            });
        });

        /* ─── Room Selection ─────────────────── */
        window.selectRoom = (card) => {
            document.querySelectorAll('.room-card').forEach(c => c.classList.remove('room-picked'));
            card.classList.add('room-picked');
            selectedSeats = [card.dataset.room];
            basePriceSum = parseInt(card.dataset.price || 0);
            applyCoupon();
            updateSelectionBar();
        };

        function updateSelectionBar() {
            document.getElementById('sel-label').textContent = '{{ type == "Hotel" and "Room" or "Seats" }}: ' + (selectedSeats.join(', ') || 'None');
            document.getElementById('sel-detail').textContent = selectedSeats.length ? 'Tap "Continue" to proceed' : 'Please select at least one.';
            document.getElementById('sel-price').textContent = '₹' + selectedPrice.toLocaleString('en-IN');

            const btn = document.getElementById('btn-next-1');
            if (selectedSeats.length > 0) {
                btn.disabled = false;
                btn.removeAttribute('disabled');
            } else {
                btn.disabled = true;
                btn.setAttribute('disabled', 'true');
            }
        }

        window.applyCoupon = () => {
            const codeBox = document.getElementById('coupon-code');
            const code = codeBox ? codeBox.value.toUpperCase().trim() : '';
            const msg = document.getElementById('coupon-msg');
            let pct = 0;

            if (code === 'ASRS50') pct = 0.5;
            else if (code === 'TRAVEL20') pct = 0.2;
            else if (code === 'WELCOME10') pct = 0.1;

            if (code && pct === 0) {
                if (msg) { msg.textContent = 'Invalid Coupon Code'; msg.style.color = '#ff4d6d'; }
                discountAmt = 0;
            } else if (code && pct > 0) {
                if (msg) { msg.textContent = 'Awesome! Code Applied Successfully.'; msg.style.color = '#06d6a0'; }
                discountAmt = Math.floor(basePriceSum * pct);
            } else {
                if (msg) msg.textContent = '';
                discountAmt = 0;
            }

            selectedPrice = basePriceSum - discountAmt;

            const dRow = document.getElementById('discount-row');
            if (dRow) {
                if (discountAmt > 0) {
                    dRow.style.display = 'flex';
                    document.getElementById('review-discount').textContent = '-₹' + discountAmt.toLocaleString();
                } else {
                    dRow.style.display = 'none';
                }
            }
            const pTot = document.getElementById('review-total');
            if (pTot) pTot.textContent = '₹' + selectedPrice.toLocaleString('en-IN');
        };

        /* ─── Step Navigation ─────────────────── */
        let pendingBookId = null;

        window.goToStep = (n) => {
            if (n === 2 && selectedSeats.length === 0) { alert('Please select a seat / room first.'); return; }
            if (n === 3) {
                // Ensure all traveler names are filled
                let allFilled = true;
                const reqInputs = document.querySelectorAll('.trav-name, .trav-age, .trav-phone, .trav-email');
                reqInputs.forEach(inp => { if (!inp.value.trim() && inp.hasAttribute('required')) allFilled = false; });
                if (!allFilled) { alert('Please fill missing traveler details (Name, Age, Phone, Email).'); return; }
            }

            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step-${i}`)?.classList.toggle('hidden', i !== n);
                const ind = document.getElementById(`step-ind-${i}`);
                if (ind) { ind.classList.toggle('active', i <= n); ind.classList.toggle('done', i < n); }
            }
            if (n === 2) {
                document.getElementById('review-seat-row').style.display = '';
                document.getElementById('review-seat-val').textContent = selectedSeats.join(', ');
                applyCoupon();

                const tList = document.getElementById('travelers-list');
                const tSect = document.getElementById('travelers-section');
                if (tList) tList.innerHTML = '';

                if (!isHotel) {
                    selectedSeats.forEach((seat, idx) => {
                        const initVal = (idx === 0) ? '{{ session_user }}' : '';
                        tList.innerHTML += `
                            <div style="margin-bottom:20px; background:rgba(255,255,255,0.03); padding:20px; border-radius:12px; border:1px solid rgba(255,159,28,0.2);">
                                <label style="font-size:13px; font-weight:800; color:var(--accent); text-transform:uppercase; letter-spacing:1px; margin-bottom:14px; display:block;">Traveler ${idx + 1} (Seat ${seat})</label>
                                
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:14px;">
                                    <div>
                                        <label style="font-size:11px;color:rgba(255,255,255,.6);display:block;margin-bottom:6px;">Full Name *</label>
                                        <input type="text" class="trav-name" placeholder="Enter full name" value="${initVal}" required style="width:100%;padding:12px 14px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,159,28,0.2);color:#fff;font-family:inherit;">
                                    </div>
                                    <div>
                                        <label style="font-size:11px;color:rgba(255,255,255,.6);display:block;margin-bottom:6px;">Age *</label>
                                        <input type="number" class="trav-age" placeholder="e.g. 28" min="1" max="100" required style="width:100%;padding:12px 14px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,159,28,0.2);color:#fff;font-family:inherit;">
                                    </div>
                                </div>
                                
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:14px;">
                                    <div>
                                        <label style="font-size:11px;color:rgba(255,255,255,.6);display:block;margin-bottom:6px;">Gender</label>
                                        <select class="trav-gender" style="width:100%;padding:12px 14px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,159,28,0.2);color:#fff;font-family:inherit;appearance:auto;cursor:pointer;">
                                            <option value="Male" style="color:#000">Male</option>
                                            <option value="Female" style="color:#000">Female</option>
                                            <option value="Other" style="color:#000">Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size:11px;color:rgba(255,255,255,.6);display:block;margin-bottom:6px;">Phone Number *</label>
                                        <input type="tel" class="trav-phone" placeholder="e.g. +91 9876543210" required style="width:100%;padding:12px 14px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,159,28,0.2);color:#fff;font-family:inherit;">
                                    </div>
                                </div>

                                <div>
                                    <label style="font-size:11px;color:rgba(255,255,255,.6);display:block;margin-bottom:6px;">Email Address *</label>
                                    <input type="email" class="trav-email" placeholder="example@gmail.com" required style="width:100%;padding:12px 14px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,159,28,0.2);color:#fff;font-family:inherit;">
                                </div>
                            </div>
                        `;
                    });
                    tSect.style.display = 'block';
                } else {
                    tSect.style.display = 'none';
                }
            }
            if (n === 3) {
                document.getElementById('pay-amount-display').textContent = '₹' + selectedPrice.toLocaleString('en-IN');
                if (!pendingBookId) {
                    pendingBookId = 'KNY-' + Math.floor(Math.random() * 900000 + 100000);

                    let tNames = [];
                    const tNodes = document.querySelectorAll('.trav-name');
                    const ages = document.querySelectorAll('.trav-age');
                    const genders = document.querySelectorAll('.trav-gender');
                    const phones = document.querySelectorAll('.trav-phone');
                    const emails = document.querySelectorAll('.trav-email');

                    tNodes.forEach((inp, i) => {
                        let nm = inp.value.trim();
                        let a = ages[i] ? ages[i].value.trim() : '';
                        let g = genders[i] ? genders[i].value : '';
                        let p = phones[i] ? phones[i].value.trim() : '';
                        let e = emails[i] ? emails[i].value.trim() : '';

                        let extras = [];
                        if (a || g) extras.push(`${a ? a + 'y ' : ''}${g}`);
                        if (p) extras.push(`Ph: ${p}`);
                        if (e) extras.push(e);

                        let fullLine = nm;
                        if (extras.length > 0) {
                            fullLine += ` (${extras.join(' | ')})`;
                        }
                        tNames.push(fullLine);
                    });

                    if (tNames.length === 0) tNames = ['{{ session_user }}'];

                    fetch('/api/book/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            booking_ref: pendingBookId,
                            service_type: '{{ type }}',
                            item_name: '{{ name }}',
                            from_city: '{{ src }}',
                            to_city: '{{ dst }}',
                            travel_date: '{{ type }}' === 'Hotel' ? '{{ date }}' : '{{ date }} | {{ dep }} - {{ arr }}',
                            seat_room: selectedSeats.join(', '),
                            passengers: isHotel ? 1 : selectedSeats.length,
                            traveler_names: tNames.join(', '),
                            class_type: '{{ cls }}',
                            price: selectedPrice,
                            pay_method: 'Pending',
                            status: 'Payment Pending'
                        })
                    }).catch(() => { });
                }
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        /* ─── Payment Method ─────────────────── */
        window.selectPayment = (el, method) => {
            document.querySelectorAll('.pay-method').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
            selectedPayMethod = method;
            document.querySelectorAll('.pay-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(`panel-${method}`).classList.remove('hidden');
        };

        window.selectUPI = (btn) => {
            document.querySelectorAll('.upi-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

        /* ─── Card Formatting ─────────────────── */
        window.fmtCard = (el) => {
            let v = el.value.replace(/\D/g, '').substring(0, 16);
            el.value = v.replace(/(.{4})/g, '$1 ').trim();
            document.getElementById('cv-num').textContent = el.value || '•••• •••• •••• ••••';
        };
        window.fmtExpiry = (el) => {
            let v = el.value.replace(/\D/g, '');
            if (v.length > 2) v = v.substring(0, 2) + '/' + v.substring(2, 4);
            el.value = v;
            document.getElementById('cv-exp').textContent = el.value || 'MM/YY';
        };

        /* ─── Process Payment ─────────────────── */
        window.processPayment = () => {
            const payBtn = document.querySelector('.pay-btn');
            payBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            payBtn.disabled = true;
            setTimeout(() => {
                const bookId = pendingBookId || ('KNY-' + Math.floor(Math.random() * 900000 + 100000));

                // Show confirmation details
                document.getElementById('confirm-id').textContent = bookId;
                document.getElementById('confirm-seat').textContent = selectedSeats.join(', ') || '—';
                document.getElementById('confirm-amount').textContent = '₹' + selectedPrice.toLocaleString('en-IN');
                document.getElementById('confirm-payment').textContent = {
                    upi: 'UPI / Online', card: 'Card Payment', cash: 'Cash at Counter'
                }[selectedPayMethod];

                let tNames = [];
                document.querySelectorAll('.trav-name').forEach(inp => tNames.push(inp.value.trim()));
                if (tNames.length > 0) {
                    document.getElementById('confirm-traveller').innerHTML = tNames.join('<br>');
                }

                goToStep(4);

                if (pendingBookId) {
                    fetch('/api/book/update-status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ booking_ref: pendingBookId, status: 'Confirmed' })
                    }).catch(() => { });
                } else {
                    if (tNames.length === 0) tNames = ['{{ session_user }}'];
                    fetch('/api/book/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            booking_ref: bookId,
                            service_type: '{{ type }}',
                            item_name: '{{ name }}',
                            from_city: '{{ src }}',
                            to_city: '{{ dst }}',
                            travel_date: '{{ type }}' === 'Hotel' ? '{{ date }}' : '{{ date }} | {{ dep }} - {{ arr }}',
                            seat_room: selectedSeats.join(', '),
                            passengers: isHotel ? 1 : selectedSeats.length,
                            traveler_names: tNames.join(', '),
                            class_type: '{{ cls }}',
                            price: selectedPrice,
                            pay_method: { upi: 'UPI/Online', card: 'Card', cash: 'Cash' }[selectedPayMethod] || 'UPI',
                            status: 'Confirmed'
                        })
                    }).catch(() => { });
                }
            }, 2200);
        };
    </script>
</body>

</html>